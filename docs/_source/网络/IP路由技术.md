# IP路由技术



## 第30章 IP路由原理

> **路由器**使能够将数据报问在不同逻辑网段间转发的网络设备。
>
> **路由**是指导路由器如何进行数据报文发送的路径信息。

### 路由表

#### 路由表构成

![image-20200815011257951](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200815011305.png)

- 目的地址/网络掩码（Destination/Mask）
- 出跳口（Interface）
- 下一跳地址（Next-hop）
- 度量值（Metric）：说明IP包需要花费多大的代价才能到达目标。

根据掩码长度，路由表表项可分为：

- 主机路由：掩码32位。匹配单一IP地址。
- 子网路由：掩码大于0，小于32。
- 默认路由：掩码0位。表明此路由匹配全部IP地址。

### 路由单跳操作

![image-20200815093241310](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200815093248.png)

- 确定下一跳后，发往对应接口，接口进行地址解析，得出链路层地址，然后对IP数据包进行数据封装解封。
- 最长匹配原则：多路由表项匹配时，选择掩码最长的。

### 路由的来源

- **直连（Direct）路由**

  无需配置，发现本接口所属网段的路由。

- **静态（Static）路由**。

  手工配置。

- **动态路由**。

  动态路由协议（Routing Protocol）发现的路由。（RIP，OSPF）。

### 路由优先级

- 路由优先级（Preference）代表路由协议的可信度。

- 通过路由优先级来决定定使用哪种路由协议的路由。

- 数值越小，优先级越高。

H3C路由默认优先级：

![image-20200815094637994](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200815094735.png)

- 除直连路由外，各动态路由协议优先级可以手工配置。

- 每条静态路由优先级可以不同。

### 第31章 直连路由和静态路由

### 直连路由

- 为路由器端口配置IP地址，即可发现直连路由。

- 终端主机需要配置相应的网关地址，为连接路由器的以太口的IP地址。

### VLAN间路由

VALN用于隔离广播域，但是设置了VLAN后，不同VLAN间的主机发出的数据帧被交换机内部隔离。

![image-20200815101803180](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200815101803.png)

- 不同VALN连接路由器不同以太网接口。
- 对路由器接口数量要求较高。

### 使用802.1Q和子接口实现VLAN间路由

使用使用802.1Q和子接口实现VLAN间路由，通过一条物理链路实现VLAN间路由。称为**“单臂路由”**。

单臂路由利用Trunk链路允许多个VLAN帧通过。

![image-20200815121610972](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200815121611.png)

跨VLAN通信流程：

1. 封装成带VLAN标签数据帧

2. 选择Trunk链路通行

3. 路由器查询路由表，查看目地地址的网段，并将数据包封装成带有该网段VLAN标签的数据帧，发送出去。

这种VLAN间路由方式只需使用路由器一个物理接口。

### 用三层交换机实现VLAN间通信

单臂路由缺点：路由器是软件转发IP报文的，如果VALN数据量较大，会消耗路由器大量CPU和内存资源，降低转发性能。

三层交换机通过内置三层路由转发引擎在VLAN间进行路由转发，由于三层路由转发引擎是用硬件实现的，性能更强，解决上述问题。

![image-20200815123439328](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200815123439.png)

### 用静态路由实现路由备份和负载分担

如再配置到达网络目的地多条路由时，若指定相同优先级，可实现**负载分担**；指定不同优先级，可实现**路由备份**。

负载分担模式下，如果两条路由带宽差距大，分配到带宽较小的路由时，可能会成为网络传输的瓶颈。

### 静态黑洞路由的应用

对应接口配置为NULL0，不能配置IP地址，向该端口发送数据包相当于丢弃。

用于避免环路产生。



## 第32章 路由协议基础

### 路由协议基本原理

1. 邻居发现阶段：发现本网段的其它路由器。
2. 交换路由信息阶段：广播或多播发送自己已知路由信息给邻居。
3. 计算路由阶段：根据路由协议特定算法，计算最终路由（计算下一跳和度量值）。
4. 维护路由阶段：发生网络故障，更新网络拓扑。

### 路由协议概述

#### 各路由协议与IP的关系

![image-20200815173645842](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200815173645.png)

- RIP采用UDP封装，端口号520。
- BGP采用TCP封装，端口号170。

#### 路由协议的分类

Internet网络规模很大，无论哪种协议都无法完成全网的路由计算所以现在的互联网被分成很多个**自治系统（Autonomous System，AS）**。

自治系统是一组共享相似路由策略并在单一管理域中运行的路由器集合。

每个自治系统都有一个唯一的自治系统编号，由以太网授权管理机构IANA分配。自治系统的编号范围是1~65535，其中1~64511是注册的互联网编号，64512~65535是专用网络编号。

##### IGP和EGP

根据工作范围的不同，路由协议可以分为IGP和EGP

![image-20200815182140090](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200815182324.png)

##### 距离矢量路由协议与链路状态协议

距离矢量协议：RIP

- 一定时间间隔向相邻的路由器发送路由更新。

链路状态协议（最短路径优先算法）：OSPF

- 具有更大的扩展性和更快的收敛速度。
- 只有当链路状态发生变化才发送路由更新。

##### 路由协议性能指标

1. 协议计算的正确性
2. 路由收敛速度：路由收敛是指全网中路由器的路由表达到一致。
3. 协议所占用的系统开销
4. 协议自身的安全性：协议安全性是指协议设计时有没有考虑防止攻击。
5. 协议使用网络规模

### 距离矢量路由协议原理

基于贝尔曼 - 福特算法。该算法关系网段的距离和方向。

路由更新规则：

1. 对本路由表中已有的路由项，当发送更新的邻居相同时，无论路由更新携带的度量值更大或是更小，都应该更新该路由。
2. 路由表中不存在的路由，度量值小于16的，增加该更新。

#### 距离矢量路由更新过程

1. 生成本网段的直连路由。

   ![image-20200816212540851](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200816212547.png)

2. 路由器定期将自己的整个路由表发送给相邻的路由器。

![image-20200816212731488](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200816212731.png)

3. 在下一更新周期，路由器会继续发送自己的这个路由表给相邻路由器。

![image-20200816212846440](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200816213022.png)

4. 经过一段时间，网络中每台设备都已经知道了与它不直接相连的网络的存在。（收敛完成）

缺点：扩散较慢。

#### 距离矢量路由协议环路产生

距离矢量路由协议实际上不了解整个网络拓扑，它们只知道与自己直接相连的网络情况。

1. 单路径网络中路有环路产生

![image-20200816225326538](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200816225421.png)

![image-20200816225337540](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200816225430.png)

![image-20200816225344707](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200816230816.png)

10.4.0.0网络故障，RTC删除了路由，但是下一次路由更新又从RTB学会来。

2. 多路径网络中路由环路的产生

![image-20200816230848147](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200816230938.png)

![image-20200816231008669](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200816231008.png)

![image-20200816231341515](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200816231540.png)

- RTC删除路由，向RTA、RTB发送更新。

- RTB收到更新后删除路由，RTA在收到更新前更新间隔到向RTB发送更新，RTB又增加了路由。

- RTA->RTB->RTC循环更新路由，跳数不断增大，网络无法收敛。

### 链路状态路由协议原理

基于Dijkstra算法，也是最短路径优先算法。

通过收集网络中的链路或接口的状态（UP或DOWN、IP地址、掩码），形成一个数据库，每个路由器节点以自己为根节点算出一棵最小生成树。

每次网络拓扑发生变化，只需发送拓扑变化相关的LSA，不需发送整个路由表，节省了带宽。



## 第33章 RIP

基于UDP协议，端口520。

### RIP协议工作过程

#### RIP路由表初始化

没启动RIP前，路由表只有直连路由。

启动RIP，发送广播，请求报文。

#### RIP路由表更新

更新原则

1. 路由表中已有的路由，发送响应报文的RIP邻居相同时，无论度量值（Metric）大小都更新。
2. 路由表中已有的路由，发送响应报文的RIP邻居不同时，度量值小更新。
3. 路由表中没有的路由，度量值小于16，增加该路由。

#### RIP路由表的维护

RIP路由信息是由定时器来完成的。

1. **Update定时器**，定义发送路由更新间隔，默认30s。
2. **Timeout定时器**，定义路由老化时间，到时将度量值设置为16，默认180s，**撤销**路由。

3. **Garbage-Collect定时器**，度量值被设为16开始，120秒没有更新路由，则**彻底删除**该路由。

### 路由环路避免

#### 路由毒化

Routing Poisoning

路由器将路由表中发生故障的路由项以度量值无限大（16）的形式告知RIP邻居。

#### 水平分割

Split Horizon 

环路原因：路由器从从某个邻居学到的路由信息又告诉这个邻居。

从某个接口学到的路由，不会再从该接口发送回邻居路由器。

#### 毒性逆转

从某个接口学到路由后，将该路由的度量值设为无穷大（16）并从原接口返回给邻居路由器。相当于告诉邻居路由器，路由不能从这回去，只能到这来。 	

#### 定义度量最大值

解决网络无法收敛的问题。

#### 抑制时间

Poison Reverse

当路由度量值被设置成16后，进入抑制状态，只有来自同一邻居（发送度量值16路由的邻居）且度量值小于16的路由才会被接受，取代不可达路由。

#### 触发更新

路由表路由信息发生改变时，路由器不必等到更新周期到来，立即发送路由更新。

### RIPv2的改进

1. 增加掩码信息

2. 支持组播路由

3. 对报文协议进行验证，增强安全性

   组播地址224.0.0.9



## 第34章 OSPF

#### RIP缺点

- 路由选择不合理（使用跳数不合理，使用网络带宽和链路时延更合理）

![image-20200817091413106](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200817091527.png)

- 网络规模限制

![image-20200817091527076](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200817091527.png)

- 收敛速度慢

  ![image-20200817091548107](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200817091548.png)

- 占用网络资源多

![image-20200817091624234](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200817095909.png)

### OSPF基本原理

OSPF封装在IP包中，协议号89

#### OSPF协议工作过程

##### 1. 寻找邻居

OSPF路由器周期性从每一个启动OSPF的接口发送**Hello包**，以寻找邻居。组播地址224.0.0.5

![image-20200817105021472](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200817105226.png)

##### 2. 建立邻接关系

OSPF路由器之间不全部相互建立邻接关系，而是与选举的DR和BDR（Backup Designated Router，备份指定路由器）建立邻接关系，以此降低资源消耗。

![image-20200817105255927](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200817105256.png)

> 广播型网络里，OSPF区域内的所有路由器可互为邻居，但是只与DR和BDR建立邻接关系。

- DR失效，BDR顶替，然后重新选举BDR
- 当OSPF路由器加入OSPF区域，继续沿用DR和BDR，不进行选举
- 路由器优先级0~255，包含在Hello包中，为0不具备选举资格，越大优先级越高

##### 3. 链路状态信息传递

建立邻接关系的OSPF路由器之间通过发布**LSA（Link State Advertisement）**来交互链路状态信息，然后各路由器形成相同的LSDB。

OSPF采用增量更新机制，避免网络资源浪费，先发送LSA摘要，邻居路由表与LSA对比，然后请求缺失的路由项。

采用重传机制保证可靠。

1. Hello邻居发现

2. DD数据库描述报文，发送摘要

3. LSR链路状态请求，请求详细路由

4. LSU链路状态更新报文，回复详细报文

5. LSAck链路状态确认

![image-20200817110715623](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200817110837.png)

##### 5. 路由计算

1. 评估一台路由器到另一台路由器所需要的开销（Cost）。

2. 同步OSPF区域内每台路由器的LSDB。

3. 使用SPF计算出最优路由，放入路由表。

   ![image-20200817111231871](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200817111318.png)

#### OSPF分区域管理

OSPF协议使用了多个数据库和复杂算法，这导致路由器消耗更多的内存和CPU资源。采用分区域管理解决该问题。

每个区域用一个32位的区域ID标识。

![image-20200817112223305](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200817112223.png)

划分区域后，通信类型分3中：

- 区域内通信——在同一个区域内的路由器之间的通信。
- 区域内通信——不同区域的路由器之间的通信。
- 区域外部通信——OSPF区域内路由器与另一个自治系统的路由器之间的通信。

为保证区域间通信，需要有一个区域作为所有区域的枢纽，称为**骨干区域（Backbone Area）**。规定区域0为骨干区域保留区域号。

所有非骨干网与骨干网相连，非骨干网区域之间不能直接交换数据包。

至少有一个接口与骨干区域相连的路由器被称为**骨干路由器（Backbone Router）**。连接一个或多个区域到骨干区域的路由器被称为**区域边界路由器（Area Border Routers，ABR）**。

OSPF区域内与其它自治系统相连的路由器称为**自治系统边界路由器（Autonomous System Boundary Router，ASBR）**。

所有接口都在区域内的称为**内部路由器（Internal Router）**，可同时担任自治系统边界路由器的任务。

![image-20200817120214176](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200817120214.png)

区域10.0.0.1使用路由聚合20.1.0.0/16描述网段内的所有路由器，减少LSA。

### OSPF的LSA类型

#### LSA类型

##### 第一类LSA

Router LSA,描述区域内部与路由器直连的链路的信息。每一台路由器都会产生，并向邻居传播。

![image-20200817123108793](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200817123108.png)

##### 第二类LSA

Network LSA，由DR产生，描述的是连接到一个特定的广播网络或NBMA（non-broadcast multiple access network）网络的一组路由器。用来保证广播网络或NBMA网络只产生一条LSA。

P2P网络不选举DR，所以没有Network LSA。

![image-20200817123513137](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200817123513.png)

##### 第三类LSA

Summary LSA，由ABR产生。将区域内的链路信息以子网的形式连接到到邻区域。实际上就是将区域内部的Type1和Type2的LSA收集起来以路由子网的形式传播。

第三类LSA直接传递路由条目，不是链路状态信息。

![image-20200817152853845](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200817152853.png)

##### 第四类 LSA

ASBR Summary LSA，由ABR生产，格式与第三类LSA相同，描述的目的网络是一个ASBR的Router ID。

![image-20200817153052264](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200817153052.png)

##### 第五类 LSA

AS External LSA，由ASBR生产，描述到AS外部的路由信息。

![image-20200817153217039](https://cdn.jsdelivr.net/gh/KevinJohn-GH/pictures//img/20200817153338.png)

LSA携带外部信息分两类：

- 来自IGP的外部路由。
- 来自EGP的外部路由。

### 边缘区域

除了骨干区域和非骨干区域之外，定义了一类特殊区域，就是边缘区域。

边缘区域优势：

- 对外部路由进行控制。
- 减小区域内LSDB规模。
- 网络设计安全性有所增强。

边缘区域分类：

1. Stub区域：不存在第四类LSA和第五类LSA
2. Totally  Stub区域：不存在 第三、四、五类LSA。
3. NSSA区域：Stub的一种改进区域，不允许第五类LSA，但允许第七类。第七类由NSSA区域的ASBR产生，第七类LSA到达NSSA的ABR时，转换成第五类。